<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escala de Valoración en Tiempo Real</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --theme-color-primary: #3b82f6; /* Azul por defecto */
            --theme-color-text: #ffffff;
            --theme-color-content-bg: #eff6ff; 
            --theme-color-primary-border: #93c5fd;
            --theme-color-primary-dark-text: #2563eb;
            --theme-color-primary-gradient-start: var(--theme-color-primary);
            --theme-color-primary-gradient-end: #60a5fa;
        }
        body { font-family: 'Inter', sans-serif; }
        .bar-transition { transition: width 0.5s ease-in-out; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--theme-color-primary);
            border-radius: 50%; width: 24px; height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #qrcode-container { background: white; border-radius: 8px; padding: 1rem; display: inline-flex; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        body.projection-mode { overflow: hidden; }
        body.projection-mode #app { max-width: 100%; width: 100%; height: 100vh; border-radius: 0; padding: 2rem; cursor: pointer; background-color: var(--theme-color-content-bg); }
        .hide-on-projection { display: flex; }
        body.projection-mode .hide-on-projection { display: none !important; }
        body.projection-mode #results-view { padding: 0; }
        body.projection-mode .results-grid { display: flex; height: 100%; }
        body.projection-mode #results-column { width: 100%; display: flex; flex-direction: column; justify-content: center; }
        body.projection-mode #results-question { text-align: center; font-size: 2.5rem; }
        .themed-bg { background-color: var(--theme-color-primary); color: var(--theme-color-text); }
        .themed-bg-hover:hover { filter: brightness(90%); }
        .themed-result-bar { background: linear-gradient(90deg, var(--theme-color-primary-gradient-start) 0%, var(--theme-color-primary-gradient-end) 100%); }
        .themed-vote-btn { border: 2px solid #d1d5db; transition: all 0.2s ease; }
        .themed-vote-btn:hover { border-color: var(--theme-color-primary); background-color: var(--theme-color-content-bg); }
        .themed-vote-btn.disabled { opacity: 0.5; pointer-events: none; }
        .themed-content-bg { background-color: var(--theme-color-content-bg); }
        #session-code { font-family: monospace; font-size: 2.25rem; font-weight: bold; letter-spacing: 0.1em; padding: 0.5rem 1rem; border: 2px dashed var(--theme-color-primary-border); border-radius: 0.5rem; color: var(--theme-color-primary-dark-text); background-color: #fff; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-2xl mx-auto rounded-xl shadow-lg transition-all duration-300 relative">

        <div id="presenter-view" class="hidden">
            <div id="create-session-form" class="themed-content-bg p-6 md:p-8 rounded-xl">
                 <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold" data-translate-key="create_title"></h2>
                    <div id="lang-selector-container-presenter">
                        <select id="lang-selector" onchange="setLanguage(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg">
                            <option value="es">Español</option>
                            <option value="ca">Català</option>
                            <option value="gl">Galego</option>
                            <option value="eu">Euskara</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="md:col-span-2">
                        <label for="question" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="question_label"></label>
                        <input type="text" id="question" class="w-full p-2 border border-gray-300 rounded-md shadow-sm" data-translate-key-placeholder="question_placeholder">
                    </div>
                    <div>
                        <label for="color-picker" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="theme_color_label"></label>
                        <input type="color" id="color-picker" value="#3b82f6" class="w-12 h-12 p-1 border border-gray-300 rounded-md cursor-pointer">
                    </div>
                </div>

                <div class="mb-4">
                    <label for="scale-type" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="scale_type_label"></label>
                    <select id="scale-type" onchange="handleScaleTypeChange()" class="w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="satisfaction" data-translate-key="scale_satisfaction"></option>
                        <option value="agreement" data-translate-key="scale_agreement"></option>
                        <option value="frequency" data-translate-key="scale_frequency"></option>
                        <option value="trafficlight" data-translate-key="scale_trafficlight"></option>
                        <option value="numeric" data-translate-key="scale_numeric"></option>
                        <option value="custom" data-translate-key="scale_custom"></option>
                    </select>
                </div>
                
                <div id="custom-scale-container" class="hidden space-y-2 mb-4">
                     <label class="block text-sm font-medium text-gray-700" data-translate-key="custom_scale_label"></label>
                     <div id="custom-labels-wrapper"></div>
                     <button onclick="addCustomLabel()" class="text-sm text-blue-600 hover:text-blue-800" data-translate-key="add_label_btn"></button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                    <button onclick="generateShareableLink()" class="w-full bg-gray-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-gray-600" data-translate-key="prepare_session_btn"></button>
                    <button onclick="hostSession()" id="host-button" class="w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                        <span id="host-button-text" data-translate-key="start_session_btn"></span>
                        <div id="host-loader" class="loader hidden ml-3"></div>
                    </button>
                </div>

                <div id="shareable-link-container" class="hidden mt-4 p-4 bg-gray-100 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-translate-key="shareable_link_title"></label>
                    <input type="text" id="shareable-link-input" readonly class="w-full p-2 border border-gray-300 rounded-md bg-white font-mono text-sm">
                </div>
                 <p class="text-center mt-8"><a href="#" onclick="event.preventDefault(); switchView('participant')" class="text-sm text-gray-500 hover:text-blue-600" data-translate-key="switch_to_participant"></a></p>
            </div>
            
            <div id="results-view" class="hidden themed-content-bg p-6 md:p-8 rounded-xl">
                <div class="flex justify-between items-start gap-4 mb-8">
                    <h2 id="results-question" class="text-4xl md:text-5xl font-extrabold flex-grow text-gray-800"></h2>
                    <div class="flex items-center gap-2 hide-on-projection">
                         <button id="stop-btn" onclick="toggleVotingStatus()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">
                            <span data-translate-key="stop_voting_btn"></span>
                        </button>
                        <button id="projection-btn" onclick="toggleProjectionMode()" class="bg-white hover:bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm border border-gray-300">
                            <span data-translate-key="projection_btn_text"></span>
                        </button>
                    </div>
                </div>
                <div class="results-grid grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 space-y-6 hide-on-projection">
                        <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
                            <h3 class="font-bold mb-2 text-gray-700" data-translate-key="scan_qr_label"></h3>
                            <div id="qrcode-container" class="mx-auto max-w-[200px]"></div>
                        </div>
                        <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
                             <h3 class="font-bold mb-2 text-gray-700" data-translate-key="direct_link_label"></h3>
                             <p id="direct-session-link" onclick="copyToClipboard('direct-session-link', 'link_copied_toast')" class="font-mono bg-gray-200 px-2 py-1 rounded text-sm my-1 break-all hover:bg-gray-300 cursor-pointer"></p>
                        </div>
                        <div class="bg-white/60 p-4 rounded-lg text-center backdrop-blur-sm">
                            <h3 class="font-bold mb-2 text-gray-700">3. <span data-translate-key="or_go_to"></span></h3>
                            <p id="app-url" class="font-mono text-sm my-1 break-all"></p>
                            <p class="text-gray-600 text-sm my-2" data-translate-key="and_enter_code"></p>
                            <span id="session-code" onclick="copyToClipboard('session-code', 'code_copied_toast')"></span>
                        </div>
                    </div>
                    <div id="results-column" class="lg:col-span-2">
                        <div id="results-container" class="space-y-4 w-full"></div>
                        <p class="text-center text-3xl md:text-4xl font-bold mt-12 text-gray-700">
                            <span data-translate-key="total_votes_label"></span>: <span id="total-votes">0</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="participant-view">
            <div id="join-session-form" class="bg-white p-6 md:p-8 rounded-xl">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold" data-translate-key="join_title"></h2>
                    <div id="lang-selector-container-participant">
                        <select id="lang-selector-participant" onchange="setLanguage(this.value)" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg">
                            <option value="es">Español</option>
                            <option value="ca">Català</option>
                            <option value="gl">Galego</option>
                            <option value="eu">Euskara</option>
                            <option value="en">English</option>
                        </select>
                    </div>
                </div>
                <label for="code-input" class="block text-sm font-medium text-gray-700 mb-1" data-translate-key="session_code_label"></label>
                <input type="text" id="code-input" class="w-full p-2 border uppercase border-gray-300 rounded-md shadow-sm" data-translate-key-placeholder="code_input_placeholder">
                <button onclick="joinSession()" class="mt-4 w-full themed-bg themed-bg-hover font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <span id="join-button-text" data-translate-key="join_btn"></span>
                    <div id="join-loader" class="loader hidden ml-3"></div>
                </button>
                <p id="join-error" class="text-red-500 text-sm mt-2 hidden"></p>
                <p class="text-center mt-8"><a href="#" onclick="event.preventDefault(); switchView('presenter')" class="text-sm text-gray-500 hover:text-blue-600" data-translate-key="switch_to_presenter"></a></p>
            </div>

            <div id="voting-view" class="hidden bg-white p-6 md:p-8 rounded-xl">
                <h2 id="vote-question" class="text-2xl font-bold mb-6"></h2>
                <div id="vote-options-container" class="flex flex-wrap justify-center gap-3"></div>
                <div id="vote-feedback" class="text-center mt-4 hidden">
                    <p id="vote-sending" class="text-gray-500" data-translate-key="vote_sending"></p>
                    <p id="vote-error" class="text-red-500"></p>
                </div>
            </div>

             <div id="voting-paused-view" class="hidden text-center py-8 bg-white p-6 md:p-8 rounded-xl">
                 <h2 class="text-2xl font-bold mt-4" data-translate-key="voting_paused_title"></h2>
                 <p class="text-gray-600" data-translate-key="voting_paused_subtitle"></p>
            </div>

            <div id="voted-view" class="hidden text-center py-8 bg-white p-6 md:p-8 rounded-xl">
                 <svg class="mx-auto h-16 w-16 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h2 class="text-2xl font-bold mt-4" data-translate-key="voted_title"></h2>
                <p class="text-gray-600" data-translate-key="voted_subtitle"></p>
            </div>
        </div>
    </div>
    
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>

    <script>
        const translations = {
            'es': { 'create_title': 'Crear una nueva escala', 'question_label': 'Afirmación o pregunta:', 'question_placeholder': 'Ej: Valora la sesión de hoy', 'theme_color_label': 'Color:', 'scale_type_label': 'Tipo de escala:', 'scale_satisfaction': 'Satisfacción (5 niveles)', 'scale_agreement': 'Acuerdo (5 niveles)', 'scale_frequency': 'Frecuencia (5 niveles)', 'scale_trafficlight': 'Comprensión / Semáforo (3 niveles)', 'scale_numeric': 'Numérica (1-10)', 'scale_custom': 'Personalizada', 'custom_scale_label': 'Etiquetas personalizadas:', 'add_label_btn': '+ Añadir etiqueta', 'prepare_session_btn': 'Preparar', 'start_session_btn': 'Iniciar', 'switch_to_participant': '¿Unirte a una sesión?', 'projection_btn_text': 'Proyectar', 'stop_voting_btn': 'Detener', 'resume_voting_btn': 'Reanudar', 'scan_qr_label': '1. Escanea QR', 'direct_link_label': '2. Comparte enlace', 'or_go_to': 'O ve a', 'and_enter_code': 'e introduce el código:', 'total_votes_label': 'Votos totales', 'join_title': 'Unirse a una valoración', 'session_code_label': 'Código de sesión:', 'code_input_placeholder': 'Introduce el código', 'join_btn': 'Unirse', 'switch_to_presenter': '¿Eres presentador?', 'voted_title': '¡Gracias por tu valoración!', 'voted_subtitle': 'Resultados en la pantalla principal.', 'vote_sending': 'Enviando...', 'voting_paused_title': 'Votación en pausa', 'voting_paused_subtitle': 'El presentador ha detenido las respuestas.', 'alert_no_question': 'Introduce una pregunta.', 'join_error_text': 'Error. Verifica el código.', 'shareable_link_title': 'Enlace de preparación:', 'link_copied_toast': 'Enlace copiado', 'code_copied_toast': 'Código copiado', 'scales': { 'satisfaction': ['Muy insatisfecho', 'Insatisfecho', 'Neutral', 'Satisfecho', 'Muy satisfecho'], 'agreement': ['Totalmente en desacuerdo', 'En desacuerdo', 'Neutral', 'De acuerdo', 'Totalmente de acuerdo'], 'frequency': ['Nunca', 'Rara vez', 'A veces', 'Frecuentemente', 'Siempre'], 'trafficlight': ['No lo entiendo', 'Tengo dudas', 'Lo entiendo'] } },
            'ca': { 'create_title': 'Crear una nova escala', 'question_label': 'Afirmació o pregunta:', 'question_placeholder': 'Ex: Valora la sessió d\'avui', 'theme_color_label': 'Color:', 'scale_type_label': 'Tipus d\'escala:', 'scale_satisfaction': 'Satisfacció (5 nivells)', 'scale_agreement': 'Acord (5 nivells)', 'scale_frequency': 'Freqüència (5 nivells)', 'scale_trafficlight': 'Comprensió / Semàfor (3 nivells)', 'scale_numeric': 'Numèrica (1-10)', 'scale_custom': 'Personalitzada', 'custom_scale_label': 'Etiquetes personalitzades:', 'add_label_btn': '+ Afegir etiqueta', 'prepare_session_btn': 'Preparar', 'start_session_btn': 'Iniciar', 'switch_to_participant': 'Unir-se a una sessió?', 'projection_btn_text': 'Projectar', 'stop_voting_btn': 'Aturar', 'resume_voting_btn': 'Reprendre', 'scan_qr_label': '1. Escaneja QR', 'direct_link_label': '2. Comparteix enllaç', 'or_go_to': 'O ves a', 'and_enter_code': 'i introdueix el codi:', 'total_votes_label': 'Vots totals', 'join_title': 'Unir-se a una valoració', 'session_code_label': 'Codi de sessió:', 'code_input_placeholder': 'Introdueix el codi', 'join_btn': 'Unir-se', 'switch_to_presenter': 'Ets presentador?', 'voted_title': 'Gràcies per la teva valoració!', 'voted_subtitle': 'Resultats a la pantalla principal.', 'vote_sending': 'Enviant...', 'voting_paused_title': 'Votació en pausa', 'voting_paused_subtitle': 'El presentador ha aturat les respostes.', 'alert_no_question': 'Introdueix una pregunta.', 'join_error_text': 'Error. Verifica el codi.', 'shareable_link_title': 'Enllaç de preparació:', 'link_copied_toast': 'Enllaç copiat', 'code_copied_toast': 'Codi copiat', 'scales': { 'satisfaction': ['Molt insatisfet', 'Insatisfet', 'Neutral', 'Satisfet', 'Molt satisfet'], 'agreement': ['Totalment en desacord', 'En desacord', 'Neutral', 'D\'acord', 'Totalment d\'acord'], 'frequency': ['Mai', 'Poques vegades', 'De vegades', 'Freqüentment', 'Sempre'], 'trafficlight': ['No ho entenc', 'Tinc dubtes', 'Ho entenc'] } },
            'gl': { 'create_title': 'Crear unha nova escala', 'question_label': 'Afirmación ou pregunta:', 'question_placeholder': 'Ex: Valora a sesión de hoxe', 'theme_color_label': 'Cor:', 'scale_type_label': 'Tipo de escala:', 'scale_satisfaction': 'Satisfacción (5 niveis)', 'scale_agreement': 'Acordo (5 niveis)', 'scale_frequency': 'Frecuencia (5 niveis)', 'scale_trafficlight': 'Comprensión / Semáforo (3 niveis)', 'scale_numeric': 'Numérica (1-10)', 'scale_custom': 'Personalizada', 'custom_scale_label': 'Etiquetas personalizadas:', 'add_label_btn': '+ Engadir etiqueta', 'prepare_session_btn': 'Preparar', 'start_session_btn': 'Iniciar', 'switch_to_participant': 'Unirse a unha sesión?', 'projection_btn_text': 'Proxectar', 'stop_voting_btn': 'Deter', 'resume_voting_btn': 'Continuar', 'scan_qr_label': '1. Escanea QR', 'direct_link_label': '2. Comparte enlace', 'or_go_to': 'Ou vai a', 'and_enter_code': 'e introduce o código:', 'total_votes_label': 'Votos totais', 'join_title': 'Unirse a unha valoración', 'session_code_label': 'Código de sesión:', 'code_input_placeholder': 'Introduce o código', 'join_btn': 'Unirse', 'switch_to_presenter': 'Es presentador?', 'voted_title': 'Grazas pola túa valoración!', 'voted_subtitle': 'Resultados na pantalla principal.', 'vote_sending': 'Enviando...', 'voting_paused_title': 'Votación en pausa', 'voting_paused_subtitle': 'O presentador detivo as respostas.', 'alert_no_question': 'Introduce unha pregunta.', 'join_error_text': 'Erro. Verifica o código.', 'shareable_link_title': 'Ligazón de preparación:', 'link_copied_toast': 'Ligazón copiada', 'code_copied_toast': 'Código copiado', 'scales': { 'satisfaction': ['Moi insatisfeito', 'Insatisfeito', 'Neutral', 'Satisfeito', 'Moi satisfeito'], 'agreement': ['Totalmente en desacordo', 'En desacordo', 'Neutral', 'De acordo', 'Totalmente de acordo'], 'frequency': ['Nunca', 'Raramente', 'Ás veces', 'Frecuentemente', 'Sempre'], 'trafficlight': ['Non o entendo', 'Teño dúbidas', 'Enténdoo'] } },
            'eu': { 'create_title': 'Eskala berria sortu', 'question_label': 'Baieztapena edo galdera:', 'question_placeholder': 'Adib: Baloratu gaurko saioa', 'theme_color_label': 'Kolorea:', 'scale_type_label': 'Eskala mota:', 'scale_satisfaction': 'Asebetetzea (5 maila)', 'scale_agreement': 'Adostasuna (5 maila)', 'scale_frequency': 'Maiztasuna (5 maila)', 'scale_trafficlight': 'Ulermena / Semaforoa (3 maila)', 'scale_numeric': 'Zenbakizkoa (1-10)', 'scale_custom': 'Pertsonalizatua', 'custom_scale_label': 'Etiketa pertsonalizatuak:', 'add_label_btn': '+ Gehitu etiketa', 'prepare_session_btn': 'Prestatu', 'start_session_btn': 'Hasi', 'switch_to_participant': 'Saio batera batu?', 'projection_btn_text': 'Proiektatu', 'stop_voting_btn': 'Gelditu', 'resume_voting_btn': 'Berrekin', 'scan_qr_label': '1. Eskaneatu QR', 'direct_link_label': '2. Partekatu esteka', 'or_go_to': 'Edo joan hona', 'and_enter_code': 'eta sartu kodea:', 'total_votes_label': 'Botoak guztira', 'join_title': 'Balorazio batera batu', 'session_code_label': 'Saioaren kodea:', 'code_input_placeholder': 'Sartu kodea', 'join_btn': 'Batu', 'switch_to_presenter': 'Aurkezlea zara?', 'voted_title': 'Eskerrik asko zure balorazioagatik!', 'voted_subtitle': 'Emaitzak pantaila nagusian.', 'vote_sending': 'Bidaliz...', 'voting_paused_title': 'Bozketa pausatuta', 'voting_paused_subtitle': 'Aurkezleak erantzunak gelditu ditu.', 'alert_no_question': 'Sartu galdera bat.', 'join_error_text': 'Errorea. Egiaztatu kodea.', 'shareable_link_title': 'Prestatzeko esteka:', 'link_copied_toast': 'Esteka kopiatu da', 'code_copied_toast': 'Kodea kopiatu da', 'scales': { 'satisfaction': ['Oso atsekabetuta', 'Atsekabetuta', 'Neutrala', 'Pozik', 'Oso pozik'], 'agreement': ['Guztiz kontra', 'Kontra', 'Neutrala', 'Alde', 'Guztiz alde'], 'frequency': ['Inoiz ez', 'Gutxitan', 'Batzuetan', 'Askotan', 'Beti'], 'trafficlight': ['Ez dut ulertzen', 'Zalantzak ditut', 'Ulertzen dut'] } },
            'en': { 'create_title': 'Create a new scale', 'question_label': 'Statement or question:', 'question_placeholder': 'E.g., Rate today\'s session', 'theme_color_label': 'Color:', 'scale_type_label': 'Scale type:', 'scale_satisfaction': 'Satisfaction (5 levels)', 'scale_agreement': 'Agreement (5 levels)', 'scale_frequency': 'Frequency (5 levels)', 'scale_trafficlight': 'Understanding / Traffic Light (3 levels)', 'scale_numeric': 'Numeric (1-10)', 'scale_custom': 'Custom', 'custom_scale_label': 'Custom labels:', 'add_label_btn': '+ Add label', 'prepare_session_btn': 'Prepare', 'start_session_btn': 'Start', 'switch_to_participant': 'Join a session?', 'projection_btn_text': 'Project', 'stop_voting_btn': 'Stop', 'resume_voting_btn': 'Resume', 'scan_qr_label': '1. Scan QR', 'direct_link_label': '2. Share link', 'or_go_to': 'Or go to', 'and_enter_code': 'and enter the code:', 'total_votes_label': 'Total votes', 'join_title': 'Join a rating', 'session_code_label': 'Session code:', 'code_input_placeholder': 'Enter code', 'join_btn': 'Join', 'switch_to_presenter': 'Are you a presenter?', 'voted_title': 'Thank you for your rating!', 'voted_subtitle': 'Results are on the main screen.', 'vote_sending': 'Sending...', 'voting_paused_title': 'Voting paused', 'voting_paused_subtitle': 'The presenter has stopped new answers.', 'alert_no_question': 'Please enter a question.', 'join_error_text': 'Error. Check the code.', 'shareable_link_title': 'Preparation link:', 'link_copied_toast': 'Link copied', 'code_copied_toast': 'Code copied', 'scales': { 'satisfaction': ['Very Unsatisfied', 'Unsatisfied', 'Neutral', 'Satisfied', 'Very Satisfied'], 'agreement': ['Strongly Disagree', 'Disagree', 'Neutral', 'Agree', 'Strongly Agree'], 'frequency': ['Never', 'Rarely', 'Sometimes', 'Frequently', 'Always'], 'trafficlight': ['Don\'t understand', 'Have doubts', 'Understand'] } }
        };
        let currentLang = 'es';
        let peer = null, hostConnection = null, guestConnections = [];
        let sessionData = {};

        function setLanguage(lang) {
            if (!translations[lang]) return;
            currentLang = lang;
            localStorage.setItem('preferred_language', lang);
            document.documentElement.lang = lang;
            document.getElementById('lang-selector').value = lang;
            document.getElementById('lang-selector-participant').value = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.getAttribute('data-translate-key');
                if (translations[lang]?.[key]) el.innerText = translations[lang][key];
            });
             document.querySelectorAll('[data-translate-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-key-placeholder');
                if (translations[lang]?.[key]) el.placeholder = translations[lang][key];
            });
            // Update select options
            Object.keys(translations.es.scales).forEach(key => {
                const option = document.querySelector(`#scale-type option[value=${key}]`);
                if (option) option.innerText = translations[lang][`scale_${key}`];
            });
        }
        
        function getContrastColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return ((r * 299) + (g * 587) + (b * 114)) / 1000 >= 128 ? '#000000' : '#ffffff';
        }

        function applyTheme(color) {
            const root = document.documentElement;
            root.style.setProperty('--theme-color-primary', color);
            root.style.setProperty('--theme-color-text', getContrastColor(color));
            root.style.setProperty('--theme-color-content-bg', color + '1A');
            root.style.setProperty('--theme-color-primary-border', color + '80');
            root.style.setProperty('--theme-color-primary-gradient-end', `color-mix(in srgb, ${color} 70%, white)`);
            const r = parseInt(color.slice(1, 3), 16), g = parseInt(color.slice(3, 5), 16), b = parseInt(color.slice(5, 7), 16);
            const darken = (c) => Math.max(0, Math.floor(c * 0.7)).toString(16).padStart(2, '0');
            root.style.setProperty('--theme-color-primary-dark-text', `#${darken(r)}${darken(g)}${darken(b)}`);
        }

        function showToast(messageKey) {
            const toast = document.getElementById('toast');
            toast.innerText = translations[currentLang][messageKey] || messageKey;
            toast.style.opacity = 1;
            setTimeout(() => { toast.style.opacity = 0; }, 2000);
        }

        function copyToClipboard(elementId, toastMessageKey) {
            navigator.clipboard.writeText(document.getElementById(elementId).innerText).then(() => showToast(toastMessageKey));
        }

        function switchView(view) {
            const isPresenter = view === 'presenter';
            document.getElementById('presenter-view').classList.toggle('hidden', !isPresenter);
            document.getElementById('participant-view').classList.toggle('hidden', isPresenter);
            document.getElementById('app').classList.toggle('max-w-5xl', isPresenter);
            document.getElementById('app').classList.toggle('max-w-2xl', !isPresenter);
            if(isPresenter) {
                document.getElementById('create-session-form').classList.remove('hidden');
                document.getElementById('results-view').classList.add('hidden');
            }
        }
        
        function handleScaleTypeChange() {
            const type = document.getElementById('scale-type').value;
            const customContainer = document.getElementById('custom-scale-container');
            if (type === 'custom') {
                customContainer.classList.remove('hidden');
                if (document.getElementById('custom-labels-wrapper').children.length === 0) {
                    addCustomLabel();
                    addCustomLabel();
                }
            } else {
                customContainer.classList.add('hidden');
            }
        }
        
        function addCustomLabel(value = '') {
            const wrapper = document.getElementById('custom-labels-wrapper');
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'w-full p-2 border border-gray-300 rounded-md shadow-sm mb-2';
            input.value = value;
            wrapper.appendChild(input);
        }

        function getScaleOptions() {
            const type = document.getElementById('scale-type').value;
            if (type === 'numeric') {
                return Array.from({length: 10}, (_, i) => ({ text: `${i + 1}`, votes: 0 }));
            }
            if (type === 'custom') {
                return Array.from(document.querySelectorAll('#custom-labels-wrapper input'))
                    .map(input => input.value.trim())
                    .filter(text => text)
                    .map(text => ({ text, votes: 0 }));
            }
            return translations[currentLang].scales[type].map(text => ({ text, votes: 0 }));
        }

        function generateShareableLink() {
            const question = document.getElementById('question').value.trim();
            if (!question) { alert(translations[currentLang]['alert_no_question']); return; }
            const options = getScaleOptions();
            if(options.length < 2) { alert('La escala debe tener al menos 2 opciones'); return; }
            const data = {
                question,
                options: options.map(o => o.text), // Guardar solo texto para el enlace
                themeColor: document.getElementById('color-picker').value,
                votingActive: true
            };
            const shareUrl = window.location.href.split('?')[0] + '?data=' + btoa(JSON.stringify(data));
            document.getElementById('shareable-link-input').value = shareUrl;
            document.getElementById('shareable-link-container').classList.remove('hidden');
            copyToClipboard('shareable-link-input', 'link_copied_toast');
        }

        function hostSession() {
            const question = document.getElementById('question').value.trim();
            if (!question) { alert(translations[currentLang]['alert_no_question']); return; }
            const options = getScaleOptions();
            if(options.length < 2) { alert('La escala debe tener al menos 2 opciones'); return; }
            
            document.getElementById('host-loader').classList.remove('hidden');
            document.getElementById('host-button-text').classList.add('hidden');
            
            sessionData = {
                question,
                themeColor: document.getElementById('color-picker').value,
                options,
                votingActive: true
            };
            applyTheme(sessionData.themeColor);

            peer = new Peer(Math.random().toString(36).substring(2, 8).toUpperCase());
            peer.on('open', id => {
                switchView('presenter');
                document.getElementById('create-session-form').classList.add('hidden');
                document.getElementById('results-view').classList.remove('hidden');
                
                const baseUrl = window.location.href.split('?')[0];
                const sessionUrl = `${baseUrl}?session=${id}`;
                
                document.getElementById('session-code').innerText = id;
                document.getElementById('direct-session-link').innerText = sessionUrl;
                document.getElementById('app-url').innerText = baseUrl.replace(/^https?:\/\//, '');
                
                const qrContainer = document.getElementById('qrcode-container');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, { text: sessionUrl, width: 160, height: 160 });
                updateResultsView();
            });
            peer.on('connection', conn => {
                guestConnections.push(conn);
                conn.on('open', () => conn.send({ type: 'session-data', payload: sessionData }));
                conn.on('data', data => handleGuestData(conn, data));
                conn.on('close', () => { guestConnections = guestConnections.filter(c => c.peer !== conn.peer); });
            });
        }
        
        function handleGuestData(conn, data) {
            if (data.type === 'vote' && sessionData.votingActive) {
                sessionData.options[data.payload.optionIndex].votes++;
                updateResultsView();
                conn.send({ type: 'vote-confirmed' });
            }
        }
        
        function broadcastUpdate() {
             guestConnections.forEach(conn => conn.send({ type: 'session-data', payload: sessionData }));
        }
        
        function toggleVotingStatus() {
            sessionData.votingActive = !sessionData.votingActive;
            const btn = document.getElementById('stop-btn');
            const key = sessionData.votingActive ? 'stop_voting_btn' : 'resume_voting_btn';
            btn.querySelector('span').innerText = translations[currentLang][key];
            btn.classList.toggle('bg-red-500', sessionData.votingActive);
            btn.classList.toggle('hover:bg-red-600', sessionData.votingActive);
            btn.classList.toggle('bg-green-500', !sessionData.votingActive);
            btn.classList.toggle('hover:bg-green-600', !sessionData.votingActive);
            broadcastUpdate();
        }

        function updateResultsView() {
            document.getElementById('results-question').innerText = sessionData.question;
            const container = document.getElementById('results-container');
            container.innerHTML = '';
            const totalVotes = sessionData.options.reduce((sum, opt) => sum + opt.votes, 0);
            document.getElementById('total-votes').innerText = totalVotes;

            sessionData.options.forEach(option => {
                const percentage = totalVotes > 0 ? (option.votes / totalVotes) * 100 : 0;
                container.innerHTML += `
                    <div>
                        <div class="flex justify-between items-baseline mb-1">
                            <span class="text-lg text-gray-800 font-medium">${option.text}</span>
                            <span class="text-lg font-bold text-gray-900">${option.votes} <span class="text-base text-gray-600 font-medium">(${percentage.toFixed(0)}%)</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-6">
                            <div class="themed-result-bar h-6 rounded-full bar-transition" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
            });
        }

        function joinSession() {
            const hostId = document.getElementById('code-input').value.trim().toUpperCase();
            if (!hostId) return;
            
            document.getElementById('join-loader').classList.remove('hidden');
            document.getElementById('join-button-text').classList.add('hidden');
            document.getElementById('join-error').classList.add('hidden');

            peer = new Peer();
            peer.on('open', () => {
                hostConnection = peer.connect(hostId, { reliable: true });
                hostConnection.on('data', data => {
                    if (data.type === 'session-data') {
                        sessionData = data.payload;
                        applyTheme(sessionData.themeColor);
                        updateParticipantView();
                    } else if (data.type === 'vote-confirmed') {
                        showVotedView();
                        setTimeout(() => hostConnection?.close(), 500);
                    }
                });
                hostConnection.on('error', () => showJoinError());
                hostConnection.on('close', () => showJoinError());
            });
            peer.on('error', () => showJoinError());
        }

        function updateParticipantView() {
            if (!sessionData.votingActive) {
                showVotingPausedView();
            } else {
                showVotingView();
            }
        }

        function showJoinError() {
            if (document.getElementById('voted-view').classList.contains('hidden')) {
                const joinError = document.getElementById('join-error');
                joinError.innerText = translations[currentLang]['join_error_text'];
                joinError.classList.remove('hidden');
                document.getElementById('join-loader').classList.add('hidden');
                document.getElementById('join-button-text').classList.remove('hidden');
            }
        }
        
        function showVotingView() {
            document.getElementById('join-session-form').classList.add('hidden');
            document.getElementById('voted-view').classList.add('hidden');
            document.getElementById('voting-paused-view').classList.add('hidden');
            document.getElementById('voting-view').classList.remove('hidden');
            
            document.getElementById('vote-question').innerText = sessionData.question;
            const container = document.getElementById('vote-options-container');
            container.innerHTML = '';
            sessionData.options.forEach((option, index) => {
                const button = document.createElement('button');
                button.className = "themed-vote-btn p-3 rounded-lg flex-grow text-center";
                button.innerText = option.text;
                button.onclick = () => castVote(index);
                container.appendChild(button);
            });
        }
        
        function showVotingPausedView() {
            document.getElementById('join-session-form').classList.add('hidden');
            document.getElementById('voted-view').classList.add('hidden');
            document.getElementById('voting-view').classList.add('hidden');
            document.getElementById('voting-paused-view').classList.remove('hidden');
        }

        function showVotedView() {
            document.getElementById('voting-view').classList.add('hidden');
            document.getElementById('voting-paused-view').classList.add('hidden');
            document.getElementById('voted-view').classList.remove('hidden');
        }

        function castVote(optionIndex) {
            if (!hostConnection) return;
            document.querySelectorAll('#vote-options-container button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('disabled');
            });
            document.getElementById('vote-feedback').classList.remove('hidden');
            hostConnection.send({ type: 'vote', payload: { optionIndex } });
        }
        
        function handleExitProjection(event) {
            if (event.key === 'Escape' || (event.type === 'click' && event.target.id !== 'stop-btn' && !event.target.closest('#stop-btn'))) {
                if (document.body.classList.contains('projection-mode')) {
                    toggleProjectionMode();
                }
            }
        }
        
        function toggleProjectionMode() {
            const isEntering = !document.body.classList.contains('projection-mode');
            document.body.classList.toggle('projection-mode');
            if (isEntering) {
                window.addEventListener('keydown', handleExitProjection);
                document.getElementById('results-view').addEventListener('click', handleExitProjection);
            } else {
                window.removeEventListener('keydown', handleExitProjection);
                document.getElementById('results-view').removeEventListener('click', handleExitProjection);
            }
        }

        function checkURLParameters() {
            const params = new URLSearchParams(window.location.search);
            const sessionId = params.get('session');
            const data = params.get('data');

            if (sessionId) {
                switchView('participant');
                document.getElementById('code-input').value = sessionId;
                joinSession();
            } else if (data) {
                switchView('presenter');
                try {
                    const decoded = JSON.parse(atob(data));
                    document.getElementById('question').value = decoded.question;
                    if (decoded.themeColor) {
                        document.getElementById('color-picker').value = decoded.themeColor;
                        applyTheme(decoded.themeColor);
                    }
                    if(decoded.options){
                        document.getElementById('scale-type').value = 'custom';
                        handleScaleTypeChange();
                        const wrapper = document.getElementById('custom-labels-wrapper');
                        wrapper.innerHTML = '';
                        decoded.options.forEach(opt => addCustomLabel(opt));
                    }
                } catch (e) { switchView('participant'); }
            } else {
                switchView('participant');
            }
        }

        window.onload = () => {
            const savedLang = localStorage.getItem('preferred_language') || 'es';
            setLanguage(savedLang);
            checkURLParameters();
            document.getElementById('color-picker').addEventListener('input', (e) => applyTheme(e.target.value));
            handleScaleTypeChange();
        };
    </script>
</body>
</html>
